<!doctype html><html lang=en><head><title>Wordpress - Move cron jobs to CLI</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><link rel=stylesheet href=../../css/theme.min.css><link rel=stylesheet href=../../css/custom.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-210TJGYC47"></script><script>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-210TJGYC47',{anonymize_ip:!0})}</script></head><body><div id=content class=mx-auto><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1"><div class=row><div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4"><a href=../../ class=text-decoration-none><img id=home-image class=rounded-circle src=../../images/avatar.jpg></a></div><div class="col-sm-8 col-12 text-sm-left text-center"><h2 class="m-0 mb-2 mt-4"><a href=../../ class=text-decoration-none>PaweÅ‚ PÅ‚otka</a></h2><p class="text-muted mb-1">Software developer from Poland ðŸ‡µðŸ‡±</p><ul id=nav-links class="list-inline mb-2"><li class=list-inline-item><a class="badge badge-white" href=../../about-me/ title="About me">About me</a></li><li class=list-inline-item><a class="badge badge-white" href=../../post/ title=Posts>Posts</a></li><li class=list-inline-item><a class="badge badge-white" href=../../categories/ title=Categories>Categories</a></li></ul><ul id=nav-social class=list-inline><li class="list-inline-item mr-3"><a href=https://github.com/pplotka target=_blank><i class="fab fa-github fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=https://www.linkedin.com/in/pawe%C5%82-p%C5%82otka-3b651bb2/ target=_blank><i class="fab fa-linkedin-in fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=https://twitter.com/plotek1 target=_blank><i class="fab fa-twitter fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=mailto:%20pawel@pplotka.pl target=_blank><i class="fas fa-at fa-1x text-muted"></i></a></li></ul></div></div><hr></header><div class=container><div class=pl-sm-2><div class=mb-3><h3 class=mb-0>Wordpress - Move cron jobs to CLI</h3><small class=text-muted>Published June 20, 2021</small><p><a href=https://pplotka.dev/tags/wordpress/ class="badge badge-secondary">wordpress</a>
<a href=https://pplotka.dev/tags/devops/ class="badge badge-secondary">devops</a></p></div><article><p>Some time ago we started to observe performance issues in our companyâ€™s site built with WordPress. One of the issues we have observed was calling crons in random user requests. It is realized by calling URL <code>https://yourdomain.com/wp-cron.php</code>. Although in this file WordPress calls PHP method <code>fastcgi_finish_request</code>, which sends a response to the user as soon as possible, the cost of calling sub-requests during the main request is worth acknowledging and improving. There are other drawbacks of this:</p><ul><li>Calling crons in request context means that it is limited, e.g. by php-fpm setting. We often have limited resources (such as memory or time limit) for HTTP requests.</li><li>Whatâ€™s worse, calling cron as http request utilizes resource (e.g. php-fpm pools that might be necessary to handle our traffic).</li></ul><p>On the Internet, there are a lot of tips on how to disable making subrequest to call crons and move them to CLI. But there is one problem. A lot of these tips suggest calling these scheduled tasks using <code>crontab</code> by calling curl (or other http callings). This addressed first problem and makes user request free of sub-requests, but does not resolve two abovementioned problems. It is surprising because WordPress comes with <code>wp cron</code> command, which supports running scheduled tasks in CLI without making HTTP calls.</p><p>In order to do this, you have to add one line to your crontab:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>*/5 * * * * wp cron event run --due-now --path<span style=color:#f92672>=</span>path_to_your_wp
</code></pre></div><p>In this case, we call the scheduled task every 5 minutes. WordPress is responsible for choosing a concrete task to run and runs it.</p><p>Of course, you also have to disable calling sub-request to <code>/wp-cron.php</code> file. In order to do that, add the following to your wp-config.php file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#a6e22e>define</span>(<span style=color:#e6db74>&#39;DISABLE_WP_CRON&#39;</span>, <span style=color:#66d9ef>true</span>);
</code></pre></div><p>In my opinion, you should also deny access to <code>wp-cron.php</code> file (because some bots might DDoS our site requesting this endpoint). I suggest making it on the application server level. For example, if you use Nginx, add the following to your host configuration:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>location</span> = <span style=color:#e6db74>/wp/wp-cron.php</span> { <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>; }
</code></pre></div></article></div></div></div><footer class="text-center pb-1"><small class=text-muted>&copy; Copyright 2021, PaweÅ‚ PÅ‚otka<br>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a>
and <a href=https://github.com/austingebauer/devise target=_blank>Devise</a></small></footer></body></html>