<!doctype html><html lang=en><head><title>Sylius Behat scenarios in Chrome Headless inside Docker</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content><link rel=stylesheet href=../../css/theme.min.css><link rel=stylesheet href=../../css/custom.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-210TJGYC47"></script><script>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-210TJGYC47',{anonymize_ip:!0})}</script></head><body><div id=content class=mx-auto><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1"><div class=row><div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4"><a href=../../ class=text-decoration-none><img id=home-image class=rounded-circle src=../../images/avatar.jpg></a></div><div class="col-sm-8 col-12 text-sm-left text-center"><h2 class="m-0 mb-2 mt-4"><a href=../../ class=text-decoration-none>PaweÅ‚ PÅ‚otka</a></h2><p class="text-muted mb-1">Software developer from Poland ðŸ‡µðŸ‡±</p><ul id=nav-links class="list-inline mb-2"><li class=list-inline-item><a class="badge badge-white" href=../../about-me/ title="About me">About me</a></li><li class=list-inline-item><a class="badge badge-white" href=../../post/ title=Posts>Posts</a></li><li class=list-inline-item><a class="badge badge-white" href=../../categories/ title=Categories>Categories</a></li></ul><ul id=nav-social class=list-inline><li class="list-inline-item mr-3"><a href=https://github.com/pplotka target=_blank><i class="fab fa-github fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=https://www.linkedin.com/in/pawe%C5%82-p%C5%82otka-3b651bb2/ target=_blank><i class="fab fa-linkedin-in fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=https://twitter.com/plotek1 target=_blank><i class="fab fa-twitter fa-1x text-muted"></i></a></li><li class="list-inline-item mr-3"><a href=mailto:%20pawel@pplotka.pl target=_blank><i class="fas fa-at fa-1x text-muted"></i></a></li></ul></div></div><hr></header><div class=container><div class=pl-sm-2><div class=mb-3><h3 class=mb-0>Sylius Behat scenarios in Chrome Headless inside Docker</h3><small class=text-muted>Published March 29, 2021</small><p><a href=https://pplotka.dev/tags/sylius/ class="badge badge-secondary">sylius</a>
<a href=https://pplotka.dev/tags/devops/ class="badge badge-secondary">devops</a>
<a href=https://pplotka.dev/tags/docker/ class="badge badge-secondary">docker</a>
<a href=https://pplotka.dev/tags/behat/ class="badge badge-secondary">behat</a></p></div><article><p>Since this <a href=https://github.com/Sylius/Sylius/pull/11505>PR</a>, Sylius has started using Chrome Headless to run theirs Behat scenario tagged with <code>@javascript</code> (scenarios that require Javascript engine to run correctly - in short, Javascript suits). After this change, it turned out that Javascript suits speed up from 13 minutes to 8.5 minutes. So, I decided also to run my Javascript suit using Chrome Headless. But there was one problem. All my environment (development, test on the local machine, and test in CI) base on Docker. Until now, I&rsquo;ve used Selenium image to run Chrome. This short post shows you how to configure your Docker environment to work with Chrome Headless.</p><style>#callout{background:#efefef;padding:1.5em 1.25em;border-radius:3px;display:flex;flex-direction:row;margin-bottom:20px}#callout-inner{margin-left:1em}@media(max-width:767px){#callout{padding:1.5em .75em 1.5em .6em}#callout-inner{margin-left:.5em}}</style><div id=callout><div>ðŸ’¡</div><div id=callout-inner>You might see this <a href=https://dev.to/kayneth/how-to-test-your-sylius-plugins-with-selenium-38ci>blog post</a> when you still want to use Selenium with Docker for Javascript suits.</div></div><p>First of all, I suppose that you work with Sylius Standard Edition. If you have a custom Docker configuration, there is no problem with adopting this solution, but it will require more effort from you.
Sylius Standard comes with two docker-compose files: one for development purposes and the second for production. For running Behat scenarios, I suggest creating the third one. We might call them <code>docker-compose.behat.yaml</code>. In this file, we might configure Chrome Headless as a Docker service and (optionally) override or create new services.</p><p>For brevity, in this blog post, we only create a Chrome service and override the environment setting for the application service. So, our <code>docker-compose.behat.yaml</code> file looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.4&#34;</span>

<span style=color:#f92672>services</span>:
  <span style=color:#f92672>php</span>:
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>APP_ENV=test_cached</span>
  <span style=color:#f92672>chrome</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>zenika/alpine-chrome</span>
    <span style=color:#f92672>shm_size</span>: <span style=color:#e6db74>&#34;2gb&#34;</span>
    <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;--enable-automation --disable-background-networking --no-default-browser-check --no-first-run --disable-popup-blocking --disable-default-apps --disable-translate --disable-extensions --no-sandbox --enable-features=Metal --headless --remote-debugging-port=9222 --remote-debugging-address=0.0.0.0 --window-size=2880,1800 --proxy-server=&#39;direct://&#39; --proxy-bypass-list=&#39;*&#39;&#34;</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>.:/srv/sylius:rw,cached</span>
</code></pre></div><p>Few lines that require explanation:</p><ol><li>First of all, you have to override the application service (in our case, called <code>php</code> to run in <code>test_cashed</code> environment).</li><li>For Chrome, we use <a href=https://github.com/Zenika/alpine-chrome>zenika/alpine-chrome</a> image. You might use another one (but not all working correctly, this one is also well documented) or create your image (but it might be a waste of time).</li><li>It is necessary to change the shm size. Without this change, Chrome crashes during tests. So I suggest setting the <code>shm_size</code> option to <code>2gb</code>.</li><li>The next thing worth noting is the command for the Chrome container. I use the same command as is used in the <a href=https://github.com/Sylius/Sylius/blob/master/.github/workflows/application.yml#L387>Sylius CI configuration</a>.</li><li>Last but not least is setting the correct volume. It is very important, and remembering about it might save your time for debugging a problem. It is necessary to upload files in the scenario&rsquo;s steps. Without this line, your test execution returns timeout for all scenarios placed after that one that tries to upload a file. In my example, I share all codebases, but it is possible to share the only directory with fixtures.</li></ol><p>The second file we should change is <code>behat.yaml</code>. We have to configure the MinkExtension&rsquo;s (so we focus only on the <code>Behat\\MinkExtension</code> section in this file) <code>base_url</code> option. In our case, the correct value is <a href=http://nginx/><code>http://nginx/</code></a> (it points to the entrypoint of our application).
Because we run Chrome Headless as a service in a container (instead of the same machine or container as an application), there is also necessary to change the option of <code>chrome_headless</code> sessions. This option refers to url to Chrome API, and for us, it is <code>http://chrome:9222</code>.</p><p>That&rsquo;s all. It&rsquo;s time for testing. For this purpose, run the command below:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose -f docker-compose.yml -f docker-compose.behat.yml exec php vendor/bin/behat --colors --strict --no-interaction -vvv -f progress -f pretty --tags<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;@javascript &amp;&amp; ~@todo &amp;&amp; ~@cli&#34;</span>
</code></pre></div><style>#callout{background:#efefef;padding:1.5em 1.25em;border-radius:3px;display:flex;flex-direction:row;margin-bottom:20px}#callout-inner{margin-left:1em}@media(max-width:767px){#callout{padding:1.5em .75em 1.5em .6em}#callout-inner{margin-left:.5em}}</style><div id=callout><div>ðŸ’¡</div><div id=callout-inner>You might use composer&rsquo;s script or Makefile to alias long commands.</div></div><p>I hope that this configuration allows you to speed up your test, especially in CI (I wish to show you a comparison of Selenium and Chrome Headless in the next blog post).</p></article></div></div></div><footer class="text-center pb-1"><small class=text-muted>&copy; Copyright 2021, PaweÅ‚ PÅ‚otka<br>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a>
and <a href=https://github.com/austingebauer/devise target=_blank>Devise</a></small></footer></body></html>